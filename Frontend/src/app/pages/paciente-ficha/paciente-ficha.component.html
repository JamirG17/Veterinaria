<!-- Contenedor principal que será la "página" blanca -->
<div class="page-header">
  <button class="btn btn-back" (click)="regresar()">
     <i class="pi pi-arrow-left"></i>
     <span>Regresar</span>
  </button>
</div>

<div class="content-card" *ngIf="detalle">

  <!-- Sección de Resumen del Paciente -->
  <div class="section-container summary-section">
    <div class="summary-header">
      <h1>{{ detalle.mascota.nombre }}</h1>
      <div class="pet-tags">
        <span class="tag">{{ detalle.mascota.raza }}</span>
        <span class="tag">{{ detalle.mascota.sexo }}</span>
        <span class="tag">{{ detalle.mascota.esterilizado ? 'Esterilizado/a' : 'No Esterilizado/a' }}</span>
      </div>
    </div>
    <div class="summary-body">
      <div class="detail-item"><span>Edad</span> {{ calcularEdad(detalle.mascota.fechaNacimiento) }}</div>
      <div class="detail-item"><span>Peso</span> {{ detalle.mascota.peso }} kg</div>
      <div class="detail-item"><span>Propietario</span> {{ detalle.propietario.nombre }} {{ detalle.propietario.apellido }}</div>
      <div class="detail-item"><span>Teléfono</span> {{ detalle.propietario.telefono }}</div>
    </div>
  </div>

  <!-- Sección de Salud Preventiva y Alertas -->
  <div class="section-container health-section">
    <h2 class="section-title"><i class="pi pi-shield"></i> Salud Preventiva y Alertas</h2>
    <div class="health-grid">
      <!-- Alergias -->
      <div class="health-subsection allergies">
        <div class="section-header">
          <h3><i class="pi pi-exclamation-triangle"></i> Alergias y Condiciones</h3>
          <button *ngIf="!isEditingAlergias" class="btn btn-sm btn-outline" (click)="activarEdicionAlergias()">Editar</button>
        </div>
        <textarea rows="4" placeholder="Sin alergias o condiciones registradas." 
                  [readonly]="!isEditingAlergias"
                  [(ngModel)]="detalle.mascota.alergias"></textarea>
        <div *ngIf="isEditingAlergias" class="edit-actions">
          <button class="btn btn-sm btn-secondary" (click)="cancelarEdicionAlergias()">Cancelar</button>
          <button class="btn btn-sm btn-primary" (click)="guardarAlergias()">Guardar</button>
        </div>
      </div>
      <!-- Vacunación -->
      <div class="health-subsection">
        <div class="section-header">
          <h3><i class="pi pi-syringe"></i> Vacunación</h3>
          <button class="btn btn-sm btn-primary" (click)="abrirModalPrevencion('VACUNA')">Añadir</button>
        </div>
        <ul class="prevention-list">
          <li *ngFor="let v of vacunas">
            <span><strong>{{ v.producto }}</strong> ({{ v.fechaAplicacion | date:'dd/MM/yy' }})</span>
            <button class="btn-icon btn-delete" (click)="eliminarPrevencion(v.id)" title="Eliminar registro"><i class="pi pi-trash"></i></button>
          </li>
          <li *ngIf="vacunas.length === 0" class="empty-item">No hay vacunas registradas.</li>
        </ul>
      </div>
      <!-- Desparasitación -->
      <div class="health-subsection">
        <div class="section-header">
          <h3><i class="pi pi-shield-check"></i> Desparasitación</h3>
          <button class="btn btn-sm btn-primary" (click)="abrirModalPrevencion('DESPARASITACION')">Añadir</button>
        </div>
         <ul class="prevention-list">
          <li *ngFor="let d of desparasitaciones">
            <span><strong>{{ d.producto }}</strong> ({{ d.fechaAplicacion | date:'dd/MM/yy' }})</span>
            <button class="btn-icon btn-delete" (click)="eliminarPrevencion(d.id)" title="Eliminar registro"><i class="pi pi-trash"></i></button>
          </li>
          <li *ngIf="desparasitaciones.length === 0" class="empty-item">No hay registros.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Sección de Historiales -->
  <div class="section-container">
    <h2 class="section-title"><i class="pi pi-history"></i> Historial General</h2>
    <!-- Pestañas de Historial -->
    <div class="tabs">
      <button class="tab-button" [class.active]="activeTab === 'clinico'" (click)="setTab('clinico')">
        Historial Clínico ({{ detalle.historialClinico.length }})
      </button>
      <button class="tab-button" [class.active]="activeTab === 'grooming'" (click)="setTab('grooming')">
        Historial Grooming ({{ detalle.historialGrooming.length }})
      </button>
      <button class="tab-button" [class.active]="activeTab === 'citas'" (click)="setTab('citas')">
        Próximas Citas ({{ detalle.proximasCitas.length }})
      </button>
    </div>

    <!-- Contenido de las Pestañas -->
    <div class="tab-content">
      <div [ngSwitch]="activeTab">
        <!-- Historial Clínico -->
        <div *ngSwitchCase="'clinico'" class="history-list">
          <div *ngIf="detalle.historialClinico.length > 0; else noClinico">
            <div *ngFor="let registro of detalle.historialClinico" class="history-item">
              <div class="history-summary" (click)="toggleHistorial(registro.id)">
                <span class="history-date">{{ registro.fecha | date:'dd/MM/yyyy' }}</span>
                <span class="history-title">{{ registro.titulo }}</span>
                <i class="pi" [ngClass]="registroExpandidoId === registro.id ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
              </div>
              <div class="history-details" [class.expanded]="registroExpandidoId === registro.id">
                <p><strong>Síntomas/Obs:</strong> {{ registro.sintomas }}</p>
                <p><strong>Diagnóstico:</strong> {{ registro.diagnostico }}</p>
                <p><strong>Tratamiento:</strong> {{ registro.tratamiento }}</p>
              </div>
            </div>
          </div>
          <ng-template #noClinico><p class="empty-message">No hay registros clínicos.</p></ng-template>
        </div>
        <!-- Historial Grooming -->
        <div *ngSwitchCase="'grooming'" class="history-list">
          <div *ngIf="detalle.historialGrooming.length > 0; else noGrooming">
              <div *ngFor="let cita of detalle.historialGrooming" class="history-item">
                <div class="history-summary" (click)="toggleGrooming(cita.id)">
                  <span class="history-date">{{ cita.fechaHora | date:'dd/MM/yyyy' }}</span>
                  <span class="history-title">{{ cita.motivo }}</span>
                  <i class="pi" [ngClass]="groomingExpandidoId === cita.id ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                </div>
                <div class="history-details" [class.expanded]="groomingExpandidoId === cita.id">
                  <p><strong>Notas:</strong> {{ cita.notasGrooming || 'Sin notas.' }}</p>
                </div>
              </div>
          </div>
          <ng-template #noGrooming><p class="empty-message">No hay registros de grooming.</p></ng-template>
        </div>
        <!-- Próximas Citas -->
        <div *ngSwitchCase="'citas'" class="history-list">
          <div *ngIf="detalle.proximasCitas.length > 0; else noProximas">
            <div *ngFor="let cita of detalle.proximasCitas" class="history-item">
              <div class="history-summary" (click)="toggleCita(cita.id)">
                <span class="history-date">{{ cita.fechaHora | date:'dd/MM/yyyy HH:mm' }}</span>
                <span class="history-title">{{ cita.motivo }} ({{ cita.area }})</span>
                <i class="pi" [ngClass]="citaExpandidaId === cita.id ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
              </div>
              <div class="history-details" [class.expanded]="citaExpandidaId === cita.id">
                <p><strong>Asignado a:</strong> {{ cita.asignadoA.username }}</p>
                <p><strong>Estado:</strong> <span class="status-badge programada">{{ cita.estado }}</span></p>
              </div>
            </div>
          </div>
           <ng-template #noProximas><p class="empty-message">No hay citas programadas.</p></ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARA AÑADIR PREVENCIÓN -->
<div class="modal-backdrop" *ngIf="showPrevencionModal">
  <div class="modal-content modal-sm">
    <h2>Añadir Registro de {{ nuevaPrevencion.tipo === 'VACUNA' ? 'Vacunación' : 'Desparasitación' }}</h2>
    <form #prevencionForm="ngForm" (ngSubmit)="guardarPrevencion(prevencionForm)">
      <div class="form-group">
        <label>Producto / Nombre</label>
        <input type="text" name="producto" [(ngModel)]="nuevaPrevencion.producto" required>
      </div>
      <div class="form-group">
        <label>Fecha de Aplicación</label>
        <input type="date" name="fechaAplicacion" [(ngModel)]="nuevaPrevencion.fechaAplicacion" required>
      </div>
      <div class="form-group">
        <label>Próxima Dosis (Opcional)</label>
        <input type="date" name="proximaFecha" [(ngModel)]="nuevaPrevencion.proximaFecha">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalPrevencion()">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="!prevencionForm.valid">Guardar</button>
      </div>
    </form>
  </div>
</div>