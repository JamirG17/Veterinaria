<div class="page-container" *ngIf="propietario">

  <div *ngIf="successMessage" class="success-alert">
    <i class="pi pi-check-circle"></i>
    <span>{{ successMessage }}</span>
  </div>

  <!-- Botón de Regresar -->
  <button class="btn btn-back" (click)="regresar()">
    <i class="pi pi-arrow-left"></i>
    <span>Regresar a la lista</span>
  </button>

  <!-- Formulario de Datos del Propietario -->
  <div class="card">
    <div class="card-header">
      <h2>Datos del Propietario</h2>
      <button class="btn btn-primary" (click)="guardarCambiosPropietario()">Guardar Cambios</button>
    </div>
    <div class="card-body owner-form">
      <div class="form-group">
        <label>Nombre</label>
        <input type="text" [(ngModel)]="propietario.nombre">
      </div>
      <div class="form-group">
        <label>Apellido</label>
        <input type="text" [(ngModel)]="propietario.apellido">
      </div>
      <div class="form-group">
        <label>DNI</label>
        <input type="text" [(ngModel)]="propietario.dni">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" [(ngModel)]="propietario.email">
      </div>
      <div class="form-group">
        <label>Teléfono</label>
        <input type="tel" [(ngModel)]="propietario.telefono">
      </div>
    </div>
  </div>
  <!-- Sección de Mascotas -->
  <div class="card">
    <div class="card-header">
      <h2>Mascotas Registradas</h2>
      <button class="btn btn-success" (click)="abrirModalMascota()">
        <i class="pi pi-plus"></i>
        <span>Agregar Mascota</span>
      </button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="styled-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Raza</th>
              <th>Sexo</th>
              <th>Esterilizado/a</th>
              <th>Años</th>
              <th>Peso (kg)</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let mascota of propietario.mascotas">
              <td>{{ mascota.nombre }}</td>
              <td>{{ mascota.raza }}</td>
              <td>{{ mascota.sexo }}</td>
              <td>{{ mascota.esterilizado ? 'Sí' : 'No' }}</td>
              <td>{{ calcularEdad(mascota.fechaNacimiento) }}</td>
              <td>{{ mascota.peso }}</td>
              <td class="actions">
                <button class="btn-icon btn-edit" (click)="abrirModalMascota(mascota)" title="Editar Mascota">
                  <i class="pi pi-pencil"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="!propietario.mascotas || propietario.mascotas.length === 0">
              <td colspan="7" class="text-center">Este propietario no tiene mascotas registradas.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modal para Mascotas (Crear/Editar) -->
<div class="modal-backdrop" *ngIf="showPetModal">
  <div class="modal-content" *ngIf="mascotaSeleccionada">
    <form #petForm="ngForm" (ngSubmit)="guardarMascota(petForm)">
      <h2>{{ mascotaSeleccionada.id > 0 ? 'Editar Mascota' : 'Nueva Mascota' }}</h2>
      
      <div class="form-group">
        <label>Nombre</label>
        <input type="text" name="nombre" [(ngModel)]="mascotaSeleccionada.nombre" required>
      </div>

      <!-- SELECTOR DE RAZA CON BÚSQUEDA CORREGIDO -->
      <div class="form-group">
        <label>Raza</label>
        <div class="custom-select-container">
          <input 
            type="text" 
            class="breed-search-input"
            placeholder="Buscar o seleccionar raza..."
            [(ngModel)]="razaSearchTerm"
            (ngModelChange)="filtrarRazas()"
            name="razaSearch"
            autocomplete="off">
          
          <ul class="breed-options-list">
            <li (click)="seleccionarRaza('otra')">Otra...</li>
            <li *ngFor="let r of razasFiltradas" (click)="seleccionarRaza(r.nombre)">
              {{ r.nombre }}
            </li>
          </ul>
        </div>
      </div>
      
      <div class="form-group" *ngIf="mostrarInputNuevaRaza">
        <label>Nombre de la Nueva Raza</label>
        <div class="input-with-button">
          <input type="text" name="nuevaRaza" [(ngModel)]="nuevaRazaNombre">
          <button type="button" class="btn btn-sm btn-primary" (click)="guardarNuevaRaza()">Guardar Raza</button>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Sexo</label>
          <div class="radio-group">
            <label><input type="radio" name="sexo" value="MACHO" [(ngModel)]="mascotaSeleccionada.sexo"> Macho</label>
            <label><input type="radio" name="sexo" value="HEMBRA" [(ngModel)]="mascotaSeleccionada.sexo"> Hembra</label>
          </div>
        </div>
        <div class="form-group checkbox-group">
          <label><input type="checkbox" name="esterilizado" [(ngModel)]="mascotaSeleccionada.esterilizado"> Esterilizado/a</label>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Fecha de Nacimiento</label>
          <input type="date" name="fechaNacimiento" [(ngModel)]="mascotaSeleccionada.fechaNacimiento" required>
        </div>
        <div class="form-group">
          <label>Peso (kg)</label>
          <input type="number" name="peso" [(ngModel)]="mascotaSeleccionada.peso" required>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalMascota()">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="!petForm.valid">Guardar</button>
      </div>
    </form>
  </div>
</div>
